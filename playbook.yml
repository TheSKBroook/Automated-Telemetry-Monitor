---
- name: Deploy product from scratch
  hosts: localhost
  become: true
  tasks:  

  # Step 1: Verify Internet Connection
  - name: Check Internet connectivity
    shell: ping -c 1 8.8.8.8
    register: internet_status
    failed_when: internet_status.rc != 0
    ignore_errors: yes

  - name: Fail if no Internet connection
    fail:
      msg: "No Internet connection detected. Please check your network."
    when: internet_status is failed

  # Step 2: Check and install docker 
  - name: Check if Docker is installed
    command: docker --version
    register: docker_installed
    ignore_errors: yes

  - name: Install Docker prerequisites and Docker only if not installed
    block:
      - name: Install dependencies for Docker
        apt:
          name: 
            - ca-certificates
            - curl
            - gnupg
          state: present
          update_cache: yes

      - name: Create Docker keyrings directory
        file:
          path: /etc/apt/keyrings
          state: directory
          mode: '0755'

      - name: Add Docker's official GPG key
        command: curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        args:
          creates: /etc/apt/keyrings/docker.asc

      - name: Ensure Docker GPG key has correct permissions
        file:
          path: /etc/apt/keyrings/docker.asc
          mode: '0644'

      - name: Add Docker repository
        shell: |
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" | \
          tee /etc/apt/sources.list.d/docker.list > /dev/null
        args:
          creates: /etc/apt/sources.list.d/docker.list

      - name: Update package index
        apt:
          update_cache: yes

      - name: Install Docker and related tools
        apt:
          name: 
            - docker-ce
            - docker-ce-cli
            - containerd.io
            - docker-buildx-plugin
            - docker-compose-plugin
          state: present
    when: docker_installed is failed
